<!DOCTYPE html>
<html lang="en">
<!--● sass --watch .\css\style.scss .\css\style.css -->

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Venda</title>
  <link rel="icon" style="height: 70px" href="../img/Eco (1).png" />
  <link
    href="https://fonts.googleapis.com/css2?family=Sansita:ital,wght@0,400;0,700;0,800;0,900;1,400;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="../stylesheets/style.css" />
</head>

<body>
  <div class="container">
    <main class="mt-5">
        <div class="container border border-4 rounded-4 border-success">
            <div class="row justify-content-center d-flex">
                <div class="d-flex align-items-center justify-content-between">
                    <h3 class="col-5 d-flex">
                        <a href="index.html">
                            <img class="img-fluid logo" src="../img/Eco (1).png" alt="">
                        </a>
                        <span class="fs-3 -- p-3 fw-bold text-body-emphasis">Eco Trilhas</span>
                    </h3>
                </div>
                <form class="" id="ticketForm" >
                    <hr>
                    <div class="row col-12">
                        <div class="form-group col-6">
                            <label for="dataVisita">Data de Visita:</label>
                            <input type="date" id="dataVisita" class="form-control" name="data" required>
                        </div>
                        <div class="form-group col-6">
                            <label for="ingressoUsado">Ingresso Usado</label>
                            <input class="form-control" id="ingressoUsado" name="ingressoUsado" value="Não" required>
                        </div>
                        <div class="form-group col-12">
                            <label for="ingressoId">Ingresso:</label>
                            <select id="ingressoId" name="ingressoId" class="form-control" required></select>
                        </div>
                        <div class="form-group col-6">
                            <label for="ingressoTipo">Tipo de Ingresso</label>
                            <select id="ingressoTipo" name="ingressoTipo" class="form-control">
                                <option value="meia">Meia</option>
                                <option value="inteira">Inteira</option>
                            </select>
                        </div>
                        <div class="form-group col-6">
                            <label for="valorIngresso">Valor Pago</label>
                            <input type="text" class="form-control" id="valorIngresso" name="valorPago" placeholder="Preço" readonly/>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center py-4">
                        <button type="submit" class="btn btn-primary form-control">Comprar</button>
                    </div>
                </form>
                <div id="ticketPrice"></div>
            </div>
        </div>
    </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('ticketForm');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    realizarPedido();
  });

  async function loadIngressoIds(dataVisita) {
    try {
      const response = await fetch(`http://127.0.0.1:5000/api/ingressos/disponiveis/${dataVisita}`);
      if (!response.ok) {
        throw new Error('Erro ao carregar ingressos disponíveis');
      }
      const ingressos = await response.json();
      const ingressoSelect = document.getElementById("ingressoId");
      ingressoSelect.innerHTML = ""; // Limpar opções existentes
      ingressos.forEach((ingresso) => {
        const option = document.createElement("option");
        option.value = ingresso.id;
        option.dataset.preco = ingresso.preco; // Adicionar o preço como data attribute
        option.text = `Ingresso ${ingresso.id} - R$ ${parseFloat(ingresso.preco).toFixed(2)}`;
        ingressoSelect.appendChild(option);
      });

      // Adicionar listener para atualizar o valor do ingresso selecionado
      ingressoSelect.addEventListener('change', () => {
        const selectedOption = ingressoSelect.selectedOptions[0];
        const preco = selectedOption ? selectedOption.dataset.preco : 0;
        document.getElementById("valorIngresso").value = `R$ ${parseFloat(preco).toFixed(2)}`;
      });

      // Atualizar o valor do ingresso com a primeira opção selecionada
      if (ingressoSelect.options.length > 0) {
        ingressoSelect.dispatchEvent(new Event('change'));
      }
    } catch (error) {
      console.error(error);
      alert("Erro ao carregar ingressos disponíveis");
    }
  }

  document.getElementById("dataVisita").addEventListener("change", (event) => {
    loadIngressoIds(event.target.value);
  });

  async function realizarPedido() {
    const usuario = JSON.parse(localStorage.getItem('user'));
    if (!usuario) {
      alert('Usuário não encontrado. Faça login novamente.');
      return;
    }

    const ingressoId = document.getElementById('ingressoId').value;
    const clienteId = usuario.id; // ID do cliente obtido do localStorage
    const dataVisita = document.getElementById('dataVisita').value; // Get visit date

    const formData = new FormData(document.getElementById("ticketForm"));
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch(`http://127.0.0.1:5000/api/pedidos/pedido/${ingressoId}/${clienteId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data)
      });

      console.log("Response status:", response.status);
      if (response.ok) {
        const result = await response.json();
        console.log("Pedido criado com sucesso:", result);

        // Verifique se o elemento com o ID "id" existe antes de definir seu valor
        const idElement = document.getElementById("id");
        if (idElement) {
          idElement.value = result.id;
        }

        const currentDateTime = new Date().toISOString();
        localStorage.setItem("purchaseDateTime", currentDateTime);

        // Armazenar informações do pedido no localStorage
        const orderDetails = {
          orderId: result.id,
          clientId: clienteId,
          visitDate: dataVisita, // Ensure this value is correctly set
          used: false,
          value: document.getElementById("valorIngresso").value
        };
        localStorage.setItem('order', JSON.stringify(orderDetails));

        alert('Pedido bem-sucedido');
        console.log("Redirecionando para code.html");
        window.location.href = "code.html";
      } else {
        console.error("Erro ao enviar dados:", response.statusText);
        alert("Erro ao enviar dados. Por favor, tente novamente.");
      }
    } catch (error) {
      console.error("Erro na solicitação:", error);
      alert("Erro ao enviar dados. Por favor, tente novamente.");
    }
  }

  // Event listener para submissão do formulário de pedido
  document.getElementById("ticketForm").addEventListener("submit", (event) => {
    event.preventDefault();
    realizarPedido();
  });
});

</script>


  <script src="../javascripts/script.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

</body>

</html>