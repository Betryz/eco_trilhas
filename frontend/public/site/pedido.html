<!DOCTYPE html>
<html lang="en">
  <!--● sass --watch .\css\style.scss .\css\style.css -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Venda</title>
    <link rel="icon" style="height: 70px" href="../img/Eco (1).png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Sansita:ital,wght@0,400;0,700;0,800;0,900;1,400;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />
  </head>
  <body>
    <div class="container">
      <main class="mt-5">
        <div class="container border border-4 rounded-4 border-success">
          <div class="row justify-content-center d-flex">
            <div class="d-flex align-items-center justify-content-between">
              <h3 class="col-5 d-flex">
                <a href="index.html"
                  ><img class="img-fluid logo" src="../img/Eco (1).png" alt=""
                /></a>
                <span class="fs-3 -- p-3 fw-bold text-body-emphasis">
                  Eco Trilhas
                </span>
              </h3>

              </div>


            <form class="" id="ticketForm" onsubmit="handleSubmit(event)">
           
            
            <hr />
              <div class="row col-12">
                <div class="form-group col-6">
                  <label for="dataVisita">Data de Visita:</label>
                  <input
                    type="date"
                    id="dataVisita"
                    class="form-control"
                    name="data"
                  />
                </div>


                <div class="form-group col-6">
                  <label for="ingressoUsado">Ingresso Usado</label>
                  <input
                    class="form-control"
                    id="ingressoUsado"
                    name="ingressoUsado"
                     value="Não"
                  />
                </div>

                <label for="ingressoId">Ingresso:</label>
                <select id="ingressoId" name="ingressoId" required></select>


                <div class="form-group col">
                  <label for="ingressoTipo">Tipo de Ingresso</label>
                  <select
                    id="ingressoTipo"
                    name="ingressoTipo"
                    class="form-control"
                  >
                    <option value="meia">Meia</option>
                    <option value="inteira">Inteira</option>
                  </select>
                </div>
             

                <div class="form-group col">
                  <label for="valorPago">Valor Pago</label>
                  <input type="text" class="form-control" id="valorIngresso" name="preco" placeholder="Preço" required>
                </div>
              </div>
              <div class="d-flex justify-content-center py-4">
                <button type="submit" class="btn btn-primary form-control">
                  Comprar
                </button>
              </div>
            </form>

            <div id="ticketPrice"></div>
          </div>
        </div>
      </main>
    </div>


    <script>
    
    async function loadIngressoIds(dataVisita) {
  const response = await fetch(`http://127.0.0.1:5000/api/ingressos/disponiveis/${dataVisita}`);
  const ingressos = await response.json();
  const ingressoSelect = document.getElementById("ingressoId");
  ingressoSelect.innerHTML = ""; // Limpar opções existentes
  
  ingressos.forEach((ingresso) => {
    const option = document.createElement("option");
    option.value = ingresso.id;
    option.dataset.preco = ingresso.preco; // Armazena o valor do ingresso como um atributo data
    option.text = `Ingresso ${ingresso.id} - R$ ${ingresso.preco.toFixed(2)}`;
    ingressoSelect.appendChild(option);
  });

  // Adicionar evento para atualizar o valor do ingresso quando selecionado
  ingressoSelect.addEventListener('change', () => {
    const selectedOption = ingressoSelect.selectedOptions[0];
    const preco = selectedOption ? selectedOption.dataset.preco : 0;
    document.getElementById("valorIngresso").value = `R$ ${parseFloat(preco).toFixed(2)}`;
  });

  // Atualizar o valor do ingresso com a primeira opção selecionada
  if (ingressoSelect.options.length > 0) {
    ingressoSelect.dispatchEvent(new Event('change'));
  }
}

document.getElementById("dataVisita").addEventListener("change", (event) => {
  loadIngressoIds(event.target.value);
});


async function handleSubmit(event) {
  event.preventDefault();
  const form = document.getElementById("ticketForm");

  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  const ingressoId = document.getElementById("ingressoId").value;
  const clienteId = document.getElementById("clienteId").value;
  const valorIngresso = document.getElementById("valorIngresso").value.replace("R$ ", "");

  // Adicionar o valor do ingresso ao corpo da solicitação
  data.valorIngresso = parseFloat(valorIngresso);

  const response = await fetch(`http://127.0.0.1:5000/api/pedidos/pedido/${ingressoId}/${clienteId}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data)
  });

  if (response.ok) {
    const result = await response.json();
    document.getElementById("id").value = result.id;
    const currentDateTime = new Date().toISOString();
    localStorage.setItem("purchaseDateTime", currentDateTime);
    window.location.href = "code.html";
  } else {
    console.error("Erro ao enviar dados:", response.statusText);
  }
}

document.getElementById("ticketForm").addEventListener("submit", handleSubmit);

  
 
  
    </script>

    <script src="../javascripts/script.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
